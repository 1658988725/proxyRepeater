#!/bin/sh

usage() {
    echo "Usage: $0 <os-platform>"
    exit 1
}

if [ $# -ne 1 ]; then
    usage $*
fi

PRO_DIR=$(pwd)
if [ ! -d  $PRO_DIR/objs ]; then
    mkdir $PRO_DIR/objs
fi

if  hash node 2>/dev/null; then
    echo 'node version:' `node -v`
else
    sudo apt-get install nodejs
fi

if  hash npm 2>/dev/null; then
    echo 'npm version:' `npm -v`
else
    sudo apt-get install npm
fi

if [ ! -d  $PRO_DIR/srs-librtmp ]; then
    git clone https://github.com/aesirteam/srs-librtmp.git
fi

cd live555/liveMedia
/bin/rm -f Makefile
cat Makefile.head $PRO_DIR/config.$1 Makefile.tail > Makefile

cd ../groupsock
/bin/rm -f Makefile
cat Makefile.head $PRO_DIR/config.$1 Makefile.tail > Makefile

cd ../UsageEnvironment
/bin/rm -f Makefile
cat Makefile.head $PRO_DIR/config.$1 Makefile.tail > Makefile

cd ../BasicUsageEnvironment
/bin/rm -f Makefile
cat Makefile.head $PRO_DIR/config.$1 Makefile.tail > Makefile

cd $PRO_DIR/srs-librtmp
/bin/rm -f Makefile
cat Makefile.tail > Makefile

cd objs
/bin/rm -f Makefile
cat $PRO_DIR/config.$1 Makefile.tail > Makefile

cd $PRO_DIR
/bin/rm -f Makefile
cat Makefile.head config.$1 Makefile.tail > Makefile

cd src
/bin/rm -f Makefile
cat $PRO_DIR/config.$1 Makefile.tail > Makefile

cd ../nodejs
/bin/rm -f binding.gyp
cp -f nobody.gyp binding.gyp
if [  -f  $1.gyp ]; then
    cp -f $1.gyp binding.gyp
fi
